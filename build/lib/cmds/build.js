function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const R = require('ramda');

var _require = require('child_process');

const spawn = _require.spawn,
      exec = _require.exec;

const format = require('chalk');
const split = require('split');
const prefixLines = require('prefix-stream-lines');
const through = require('throo');
const docker = require('../docker-api');

const color = c => {
  return through((push, chunk, enc, cb) => {
    push(format[c](chunk) + '\n');
    cb();
  });
};

const _buildImage = ({ file, context = './', tags = [], args = [] }) => {
  const tagArgs = R.flatten(tags.map(tag => ['-t', tag]));
  const buildArgs = R.pipe(R.toPairs, R.map(([key, value]) => ['--build-arg', `${ key }=${ value }`]), R.flatten)(args);
  const dockerArgs = ['build', ...tagArgs, ...buildArgs, '-f', file, context];
  process.stdout.write(`  > docker ${ dockerArgs.join(' ') }\n`);
  return spawn('docker', dockerArgs);
};

const buildImage = (serviceName, image) => new Promise((resolve, reject) => {
  const p = _buildImage(image);
  p.stdout.pipe(split()).pipe(color('yellow')).pipe(prefixLines(`${ serviceName } | `)).pipe(process.stdout);
  p.stderr.pipe(split()).pipe(color('red')).pipe(prefixLines(`${ serviceName } | `)).pipe(process.stderr);
  p.on('error', reject).on('close', exitCode => exitCode === 0 ? resolve() : reject(exitCode));
});

const removeDangling = imagesThatMatchedTags => {
  return Promise.all(imagesThatMatchedTags.map(image => docker.getImage(image.Id).then(info => {
    if (!info.RepoTags.length) {
      // no longer tagged (is dangling)
      process.stdout.write(`Removing dangling image ${ info.Id }, previously tagged "${ image.RepoTags.join(' ') }"\n`);
      return docker.rmi(info.Id);
    }
    return Promise.resolve();
  })));
};

const buildImageAndRemoveDangling = (() => {
  var _ref = _asyncToGenerator(function* (serviceName, image) {
    const imagesThatMatchTags = yield Promise.all(image.tags.map(function (tag) {
      return docker.getImage(tag);
    }));
    yield buildImage(serviceName, image);
    yield removeDangling(imagesThatMatchTags);
    return;
  });

  return function buildImageAndRemoveDangling(_x, _x2) {
    return _ref.apply(this, arguments);
  };
})();

const buildImages = toBuild => {
  try {
    toBuild.forEach(([name, images]) => {
      images.forEach(image => {
        if (!(image.file && image.file.length)) {
          throw new Error(`no Dockerfile path given for "${ name }" service image`);
        }
      });
    });
  } catch (err) {
    return Promise.reject(err);
  }
  return toBuild.reduce((promise, [name, images]) => {
    return promise.then(() => {
      return images.reduce((promise, image) => {
        return promise.then(() => buildImageAndRemoveDangling(name, image));
      }, Promise.resolve());
    });
  }, Promise.resolve());
};

const filter = R.pipe(R.toPairs, R.map(R.over(R.lensIndex(1), R.view(R.lensProp('image')))), R.filter(R.pipe(R.view(R.lensIndex(1)), R.both(Array.isArray, R.complement(R.isEmpty)))));

const build = (selectedServices, config) => {
  return buildImages(filter(selectedServices));
};

module.exports = build;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvY21kcy9idWlsZC5qcyJdLCJuYW1lcyI6WyJSIiwicmVxdWlyZSIsInNwYXduIiwiZXhlYyIsImZvcm1hdCIsInNwbGl0IiwicHJlZml4TGluZXMiLCJ0aHJvdWdoIiwiZG9ja2VyIiwiY29sb3IiLCJjIiwicHVzaCIsImNodW5rIiwiZW5jIiwiY2IiLCJfYnVpbGRJbWFnZSIsImZpbGUiLCJjb250ZXh0IiwidGFncyIsImFyZ3MiLCJ0YWdBcmdzIiwiZmxhdHRlbiIsIm1hcCIsInRhZyIsImJ1aWxkQXJncyIsInBpcGUiLCJ0b1BhaXJzIiwia2V5IiwidmFsdWUiLCJkb2NrZXJBcmdzIiwicHJvY2VzcyIsInN0ZG91dCIsIndyaXRlIiwiam9pbiIsImJ1aWxkSW1hZ2UiLCJzZXJ2aWNlTmFtZSIsImltYWdlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJwIiwic3RkZXJyIiwib24iLCJleGl0Q29kZSIsInJlbW92ZURhbmdsaW5nIiwiaW1hZ2VzVGhhdE1hdGNoZWRUYWdzIiwiYWxsIiwiZ2V0SW1hZ2UiLCJJZCIsInRoZW4iLCJpbmZvIiwiUmVwb1RhZ3MiLCJsZW5ndGgiLCJybWkiLCJidWlsZEltYWdlQW5kUmVtb3ZlRGFuZ2xpbmciLCJpbWFnZXNUaGF0TWF0Y2hUYWdzIiwiYnVpbGRJbWFnZXMiLCJ0b0J1aWxkIiwiZm9yRWFjaCIsIm5hbWUiLCJpbWFnZXMiLCJFcnJvciIsImVyciIsInJlZHVjZSIsInByb21pc2UiLCJmaWx0ZXIiLCJvdmVyIiwibGVuc0luZGV4IiwidmlldyIsImxlbnNQcm9wIiwiYm90aCIsIkFycmF5IiwiaXNBcnJheSIsImNvbXBsZW1lbnQiLCJpc0VtcHR5IiwiYnVpbGQiLCJzZWxlY3RlZFNlcnZpY2VzIiwiY29uZmlnIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxJQUFJQyxRQUFRLE9BQVIsQ0FBVjs7ZUFDc0JBLFFBQVEsZUFBUixDOztN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Q0FBVixLQUE2QjtBQUNqRCxXQUFPSSxRQUFRZixJQUFSLENBQWEsTUFBTTtBQUN4QixhQUFPVyxPQUFPRyxNQUFQLENBQWMsQ0FBQ0MsT0FBRCxFQUFVNUIsS0FBVixLQUFvQjtBQUN2QyxlQUFPNEIsUUFBUWYsSUFBUixDQUFhLE1BQU1LLDRCQUE0QkssSUFBNUIsRUFBa0N2QixLQUFsQyxDQUFuQixDQUFQO0FBQ0QsT0FGTSxFQUVKQyxRQUFRQyxPQUFSLEVBRkksQ0FBUDtBQUdELEtBSk0sQ0FBUDtBQUtELEdBTk0sRUFNSkQsUUFBUUMsT0FBUixFQU5JLENBQVA7QUFPRCxDQXBCRDs7QUFzQkEsTUFBTTJCLFNBQVNqRSxFQUFFeUIsSUFBRixDQUNiekIsRUFBRTBCLE9BRFcsRUFFYjFCLEVBQUVzQixHQUFGLENBQ0V0QixFQUFFa0UsSUFBRixDQUNFbEUsRUFBRW1FLFNBQUYsQ0FBWSxDQUFaLENBREYsRUFFRW5FLEVBQUVvRSxJQUFGLENBQU9wRSxFQUFFcUUsUUFBRixDQUFXLE9BQVgsQ0FBUCxDQUZGLENBREYsQ0FGYSxFQVFickUsRUFBRWlFLE1BQUYsQ0FDRWpFLEVBQUV5QixJQUFGLENBQ0V6QixFQUFFb0UsSUFBRixDQUFPcEUsRUFBRW1FLFNBQUYsQ0FBWSxDQUFaLENBQVAsQ0FERixFQUVFbkUsRUFBRXNFLElBQUYsQ0FBT0MsTUFBTUMsT0FBYixFQUFzQnhFLEVBQUV5RSxVQUFGLENBQWF6RSxFQUFFMEUsT0FBZixDQUF0QixDQUZGLENBREYsQ0FSYSxDQUFmOztBQWdCQSxNQUFNQyxRQUFRLENBQUNDLGdCQUFELEVBQW1CQyxNQUFuQixLQUE4QjtBQUMxQyxTQUFPckIsWUFBWVMsT0FBT1csZ0JBQVAsQ0FBWixDQUFQO0FBQ0QsQ0FGRDs7QUFJQUUsT0FBT0MsT0FBUCxHQUFpQkosS0FBakIiLCJmaWxlIjoiYnVpbGQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBSID0gcmVxdWlyZSgncmFtZGEnKVxuY29uc3Qge3NwYXduLCBleGVjfSA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKVxuY29uc3QgZm9ybWF0ID0gcmVxdWlyZSgnY2hhbGsnKVxuY29uc3Qgc3BsaXQgPSByZXF1aXJlKCdzcGxpdCcpXG5jb25zdCBwcmVmaXhMaW5lcyA9IHJlcXVpcmUoJ3ByZWZpeC1zdHJlYW0tbGluZXMnKVxuY29uc3QgdGhyb3VnaCA9IHJlcXVpcmUoJ3Rocm9vJylcbmNvbnN0IGRvY2tlciA9IHJlcXVpcmUoJy4uL2RvY2tlci1hcGknKVxuXG5jb25zdCBjb2xvciA9IChjKSA9PiB7XG4gIHJldHVybiB0aHJvdWdoKChwdXNoLCBjaHVuaywgZW5jLCBjYikgPT4ge1xuICAgIHB1c2goZm9ybWF0W2NdKGNodW5rKSArICdcXG4nKVxuICAgIGNiKClcbiAgfSlcbn1cblxuY29uc3QgX2J1aWxkSW1hZ2UgPSAoe2ZpbGUsIGNvbnRleHQgPSAnLi8nLCB0YWdzID0gW10sIGFyZ3MgPSBbXX0pID0+IHtcbiAgY29uc3QgdGFnQXJncyA9IFIuZmxhdHRlbih0YWdzLm1hcCh0YWcgPT4gWyctdCcsIHRhZ10pKVxuICBjb25zdCBidWlsZEFyZ3MgPSBSLnBpcGUoXG4gICAgUi50b1BhaXJzLFxuICAgIFIubWFwKChba2V5LCB2YWx1ZV0pID0+IFsnLS1idWlsZC1hcmcnLCBgJHtrZXl9PSR7dmFsdWV9YF0pLFxuICAgIFIuZmxhdHRlblxuICApKGFyZ3MpXG4gIGNvbnN0IGRvY2tlckFyZ3MgPSBbJ2J1aWxkJywgLi4udGFnQXJncywgLi4uYnVpbGRBcmdzLCAnLWYnLCBmaWxlLCBjb250ZXh0XVxuICBwcm9jZXNzLnN0ZG91dC53cml0ZShgICA+IGRvY2tlciAke2RvY2tlckFyZ3Muam9pbignICcpfVxcbmApXG4gIHJldHVybiBzcGF3bignZG9ja2VyJywgZG9ja2VyQXJncylcbn1cblxuY29uc3QgYnVpbGRJbWFnZSA9IChzZXJ2aWNlTmFtZSwgaW1hZ2UpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgY29uc3QgcCA9IF9idWlsZEltYWdlKGltYWdlKVxuICBwLnN0ZG91dFxuICAgIC5waXBlKHNwbGl0KCkpXG4gICAgLnBpcGUoY29sb3IoJ3llbGxvdycpKVxuICAgIC5waXBlKHByZWZpeExpbmVzKGAke3NlcnZpY2VOYW1lfSB8IGApKVxuICAgIC5waXBlKHByb2Nlc3Muc3Rkb3V0KVxuICBwLnN0ZGVyclxuICAgIC5waXBlKHNwbGl0KCkpXG4gICAgLnBpcGUoY29sb3IoJ3JlZCcpKVxuICAgIC5waXBlKHByZWZpeExpbmVzKGAke3NlcnZpY2VOYW1lfSB8IGApKVxuICAgIC5waXBlKHByb2Nlc3Muc3RkZXJyKVxuICBwXG4gICAgLm9uKCdlcnJvcicsIHJlamVjdClcbiAgICAub24oJ2Nsb3NlJywgZXhpdENvZGUgPT4gZXhpdENvZGUgPT09IDAgPyByZXNvbHZlKCkgOiByZWplY3QoZXhpdENvZGUpKVxufSlcblxuY29uc3QgcmVtb3ZlRGFuZ2xpbmcgPSAoaW1hZ2VzVGhhdE1hdGNoZWRUYWdzKSA9PiB7XG4gIHJldHVybiBQcm9taXNlLmFsbChpbWFnZXNUaGF0TWF0Y2hlZFRhZ3NcbiAgICAubWFwKGltYWdlID0+IGRvY2tlci5nZXRJbWFnZShpbWFnZS5JZCkudGhlbihpbmZvID0+IHtcbiAgICAgIGlmICghaW5mby5SZXBvVGFncy5sZW5ndGgpIHsgLy8gbm8gbG9uZ2VyIHRhZ2dlZCAoaXMgZGFuZ2xpbmcpXG4gICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKFxuICAgICAgICAgIGBSZW1vdmluZyBkYW5nbGluZyBpbWFnZSAke2luZm8uSWR9LCBwcmV2aW91c2x5IHRhZ2dlZCBcIiR7aW1hZ2UuUmVwb1RhZ3Muam9pbignICcpfVwiXFxuYFxuICAgICAgICApXG4gICAgICAgIHJldHVybiBkb2NrZXIucm1pKGluZm8uSWQpXG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICB9KSlcbiAgKVxufVxuXG5jb25zdCBidWlsZEltYWdlQW5kUmVtb3ZlRGFuZ2xpbmcgPSBhc3luYyAoc2VydmljZU5hbWUsIGltYWdlKSA9PiB7XG4gIGNvbnN0IGltYWdlc1RoYXRNYXRjaFRhZ3MgPSBhd2FpdCBQcm9taXNlLmFsbChpbWFnZS50YWdzLm1hcCh0YWcgPT4gZG9ja2VyLmdldEltYWdlKHRhZykpKVxuICBhd2FpdCBidWlsZEltYWdlKHNlcnZpY2VOYW1lLCBpbWFnZSlcbiAgYXdhaXQgcmVtb3ZlRGFuZ2xpbmcoaW1hZ2VzVGhhdE1hdGNoVGFncylcbiAgcmV0dXJuXG59XG5cbmNvbnN0IGJ1aWxkSW1hZ2VzID0gdG9CdWlsZCA9PiB7XG4gIHRyeSB7XG4gICAgdG9CdWlsZC5mb3JFYWNoKChbbmFtZSwgaW1hZ2VzXSkgPT4ge1xuICAgICAgaW1hZ2VzLmZvckVhY2goaW1hZ2UgPT4ge1xuICAgICAgICBpZiAoIShpbWFnZS5maWxlICYmIGltYWdlLmZpbGUubGVuZ3RoKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgbm8gRG9ja2VyZmlsZSBwYXRoIGdpdmVuIGZvciBcIiR7bmFtZX1cIiBzZXJ2aWNlIGltYWdlYClcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG4gIGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKVxuICB9XG4gIHJldHVybiB0b0J1aWxkLnJlZHVjZSgocHJvbWlzZSwgW25hbWUsIGltYWdlc10pID0+IHtcbiAgICByZXR1cm4gcHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgIHJldHVybiBpbWFnZXMucmVkdWNlKChwcm9taXNlLCBpbWFnZSkgPT4ge1xuICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKCgpID0+IGJ1aWxkSW1hZ2VBbmRSZW1vdmVEYW5nbGluZyhuYW1lLCBpbWFnZSkpXG4gICAgICB9LCBQcm9taXNlLnJlc29sdmUoKSlcbiAgICB9KVxuICB9LCBQcm9taXNlLnJlc29sdmUoKSlcbn1cblxuY29uc3QgZmlsdGVyID0gUi5waXBlKFxuICBSLnRvUGFpcnMsXG4gIFIubWFwKFxuICAgIFIub3ZlcihcbiAgICAgIFIubGVuc0luZGV4KDEpLFxuICAgICAgUi52aWV3KFIubGVuc1Byb3AoJ2ltYWdlJykpXG4gICAgKVxuICApLFxuICBSLmZpbHRlcihcbiAgICBSLnBpcGUoXG4gICAgICBSLnZpZXcoUi5sZW5zSW5kZXgoMSkpLFxuICAgICAgUi5ib3RoKEFycmF5LmlzQXJyYXksIFIuY29tcGxlbWVudChSLmlzRW1wdHkpKVxuICAgIClcbiAgKVxuKVxuXG5jb25zdCBidWlsZCA9IChzZWxlY3RlZFNlcnZpY2VzLCBjb25maWcpID0+IHtcbiAgcmV0dXJuIGJ1aWxkSW1hZ2VzKGZpbHRlcihzZWxlY3RlZFNlcnZpY2VzKSlcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBidWlsZFxuIl19