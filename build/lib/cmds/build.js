function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const R = require('ramda');

var _require = require('child_process');

const spawn = _require.spawn,
      exec = _require.exec;

const format = require('chalk');
const split = require('split');
const prefixLines = require('prefix-stream-lines');
const through = require('throo');
const pify = require('pify-proto');
const docker = pify(require('docker-remote-api')());

const getImage = nameOrId => docker.get(`/images/${ nameOrId }/json`, { json: true });
const getImages = docker.get('/images/json', { json: true });

const rmi = id => docker.delete(`/images/${ id }`, { json: true });

const color = c => {
  return through((push, chunk, enc, cb) => {
    push(format[c](chunk) + '\n');
    cb();
  });
};

const _buildImage = ({ file, context = './', tags = [], args = [] }) => {
  const tagArgs = R.flatten(tags.map(tag => ['-t', tag]));
  const buildArgs = R.pipe(R.toPairs, R.map(([key, value]) => ['--build-arg', `${ key }=${ value }`]), R.flatten)(args);
  const dockerArgs = ['build', ...tagArgs, ...buildArgs, '-f', file, context];
  process.stdout.write(`  > docker ${ dockerArgs.join(' ') }\n`);
  return spawn('docker', dockerArgs);
};

const buildImage = (serviceName, image) => new Promise((resolve, reject) => {
  const p = _buildImage(image);
  p.stdout.pipe(split()).pipe(color('yellow')).pipe(prefixLines(`${ serviceName } | `)).pipe(process.stdout);
  p.stderr.pipe(split()).pipe(color('red')).pipe(prefixLines(`${ serviceName } | `)).pipe(process.stderr);
  p.on('error', reject).on('close', exitCode => exitCode === 0 ? resolve() : reject(exitCode));
});

const removeDangling = imagesThatMatchedTags => {
  return Promise.all(imagesThatMatchedTags.map(image => getImage(image.Id).then(info => {
    if (!info.RepoTags.length) {
      // no longer tagged (is dangling)
      process.stdout.write(`Removing dangling image ${ info.Id }, previously tagged "${ image.RepoTags.join(' ') }"\n`);
      return rmi(info.Id);
    }
    return Promise.resolve();
  })));
};

const buildImageAndRemoveDangling = (() => {
  var _ref = _asyncToGenerator(function* (serviceName, image) {
    const imagesThatMatchTags = yield Promise.all(image.tags.map(function (tag) {
      return getImage(tag);
    }));
    const imageIdsThatMatchTags = imagesThatMatchTags.map(function (info) {
      return info.Id;
    });
    yield buildImage(serviceName, image);
    yield removeDangling(imagesThatMatchTags);
    return;
  });

  return function buildImageAndRemoveDangling(_x, _x2) {
    return _ref.apply(this, arguments);
  };
})();

const buildImages = toBuild => {
  try {
    toBuild.forEach(([name, images]) => {
      images.forEach(image => {
        if (!(image.file && image.file.length)) {
          throw new Error(`no Dockerfile path given for "${ name }" service image`);
        }
      });
    });
  } catch (err) {
    return Promise.reject(err);
  }
  return toBuild.reduce((promise, [name, images]) => {
    return promise.then(() => {
      return images.reduce((promise, image) => {
        return promise.then(() => buildImageAndRemoveDangling(name, image));
      }, Promise.resolve());
    });
  }, Promise.resolve());
};

const build = (config, { services = [] }) => {
  const selectedServices = R.ifElse(() => R.isEmpty(services), // no services specified
  () => config.services, // use all of them
  () => R.pipe( // filter config down to given services
  R.toPairs, R.filter(([name]) => services.includes(name)), R.fromPairs)(config.services))();
  const toBuild = R.pipe(R.toPairs,
  // just handle image property
  R.map(([name, value]) => [name, value.image]),
  // filter out image settings that are strings (nothing to build)
  R.filter(([name, value]) => value && typeof value !== 'string'),
  // normalize to array of objects rather than having to check for array/object in further code
  //   because the image setting can specify multiple images to build
  R.map(([name, value]) => Array.isArray(value) ? [name, value] : [name, [value]]),
  // normalize image.tag to array
  R.map(([name, images]) => [name, images.map(image => R.over(R.lensProp('tags'), x => Array.isArray(x) ? x : [x], image))]))(selectedServices);
  return buildImages(toBuild);
};

module.exports = build;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvY21kcy9idWlsZC5qcyJdLCJuYW1lcyI6WyJSIiwicmVxdWlyZSIsInNwYXduIiwiZXhlYyIsImZvcm1hdCIsInNwbGl0IiwicHJlZml4TGluZXMiLCJ0aHJvdWdoIiwicGlmeSIsImRvY2tlciIsImdldEltYWdlIiwibmFtZU9ySWQiLCJnZXQiLCJqc29uIiwiZ2V0SW1hZ2VzIiwicm1pIiwiaWQiLCJkZWxldGUiLCJjb2xvciIsImMiLCJwdXNoIiwiY2h1bmsiLCJlbmMiLCJjYiIsIl9idWlsZEltYWdlIiwiZmlsZSIsImNvbnRleHQiLCJ0YWdzIiwiYXJncyIsInRhZ0FyZ3MiLCJmbGF0dGVuIiwibWFwIiwidGFnIiwiYnVpbGRBcmdzIiwicGlwZSIsInRvUGFpcnMiLCJrZXkiLCJ2YWx1ZSIsImRvY2tlckFyZ3MiLCJwcm9jZXNzIiwic3Rkb3V0Iiwid3JpdGUiLCJqb2luIiwiYnVpbGRJbWFnZSIsInNlcnZpY2VOYW1lIiwiaW1hZ2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInAiLCJzdGRlcnIiLCJvbiIsImV4aXRDb2RlIiwicmVtb3ZlRGFuZ2xpbmciLCJpbWFnZXNUaGF0TWF0Y2hlZFRhZ3MiLCJhbGwiLCJJZCIsInRoZW4iLCJpbmZvIiwiUmVwb1RhZ3MiLCJsZW5ndGgiLCJidWlsZEltYWdlQW5kUmVtb3ZlRGFuZ2xpbmciLCJpbWFnZXNUaGF0TWF0Y2hUYWdzIiwiaW1hZ2VJZHNUaGF0TWF0Y2hUYWdzIiwiYnVpbGRJbWFnZXMiLCJ0b0J1aWxkIiwiZm9yRWFjaCIsIm5hbWUiLCJpbWFnZXMiLCJFcnJvciIsImVyciIsInJlZHVjZSIsInByb21pc2UiLCJidWlsZCIsImNvbmZpZyIsInNlcnZpY2VzIiwic2VsZWN0ZWRTZXJ2aWNlcyIsImlmRWxzZSIsImlzRW1wdHkiLCJmaWx0ZXIiLCJpbmNsdWRlcyIsImZyb21QYWlycyIsIkFycmF5IiwiaXNBcnJheSIsIm92ZXIiLCJsZW5zUHJvcCIsIngi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QWhCO0FBbUJBLFNBQU9aLFlBQVlDLE9BQVosQ0FBUDtBQUNELENBOUJEOztBQWdDQXNCLE9BQU9DLE9BQVAsR0FBaUJmLEtBQWpCIiwiZmlsZSI6ImJ1aWxkLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgUiA9IHJlcXVpcmUoJ3JhbWRhJylcbmNvbnN0IHtzcGF3biwgZXhlY30gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJylcbmNvbnN0IGZvcm1hdCA9IHJlcXVpcmUoJ2NoYWxrJylcbmNvbnN0IHNwbGl0ID0gcmVxdWlyZSgnc3BsaXQnKVxuY29uc3QgcHJlZml4TGluZXMgPSByZXF1aXJlKCdwcmVmaXgtc3RyZWFtLWxpbmVzJylcbmNvbnN0IHRocm91Z2ggPSByZXF1aXJlKCd0aHJvbycpXG5jb25zdCBwaWZ5ID0gcmVxdWlyZSgncGlmeS1wcm90bycpXG5jb25zdCBkb2NrZXIgPSBwaWZ5KHJlcXVpcmUoJ2RvY2tlci1yZW1vdGUtYXBpJykoKSlcblxuY29uc3QgZ2V0SW1hZ2UgPSAobmFtZU9ySWQpID0+IGRvY2tlci5nZXQoYC9pbWFnZXMvJHtuYW1lT3JJZH0vanNvbmAsIHtqc29uOiB0cnVlfSlcbmNvbnN0IGdldEltYWdlcyA9IGRvY2tlci5nZXQoJy9pbWFnZXMvanNvbicsIHtqc29uOiB0cnVlfSlcblxuY29uc3Qgcm1pID0gKGlkKSA9PiBkb2NrZXIuZGVsZXRlKGAvaW1hZ2VzLyR7aWR9YCwge2pzb246IHRydWV9KVxuXG5jb25zdCBjb2xvciA9IChjKSA9PiB7XG4gIHJldHVybiB0aHJvdWdoKChwdXNoLCBjaHVuaywgZW5jLCBjYikgPT4ge1xuICAgIHB1c2goZm9ybWF0W2NdKGNodW5rKSArICdcXG4nKVxuICAgIGNiKClcbiAgfSlcbn1cblxuY29uc3QgX2J1aWxkSW1hZ2UgPSAoe2ZpbGUsIGNvbnRleHQgPSAnLi8nLCB0YWdzID0gW10sIGFyZ3MgPSBbXX0pID0+IHtcbiAgY29uc3QgdGFnQXJncyA9IFIuZmxhdHRlbih0YWdzLm1hcCh0YWcgPT4gWyctdCcsIHRhZ10pKVxuICBjb25zdCBidWlsZEFyZ3MgPSBSLnBpcGUoXG4gICAgUi50b1BhaXJzLFxuICAgIFIubWFwKChba2V5LCB2YWx1ZV0pID0+IFsnLS1idWlsZC1hcmcnLCBgJHtrZXl9PSR7dmFsdWV9YF0pLFxuICAgIFIuZmxhdHRlblxuICApKGFyZ3MpXG4gIGNvbnN0IGRvY2tlckFyZ3MgPSBbJ2J1aWxkJywgLi4udGFnQXJncywgLi4uYnVpbGRBcmdzLCAnLWYnLCBmaWxlLCBjb250ZXh0XVxuICBwcm9jZXNzLnN0ZG91dC53cml0ZShgICA+IGRvY2tlciAke2RvY2tlckFyZ3Muam9pbignICcpfVxcbmApXG4gIHJldHVybiBzcGF3bignZG9ja2VyJywgZG9ja2VyQXJncylcbn1cblxuY29uc3QgYnVpbGRJbWFnZSA9IChzZXJ2aWNlTmFtZSwgaW1hZ2UpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgY29uc3QgcCA9IF9idWlsZEltYWdlKGltYWdlKVxuICBwLnN0ZG91dFxuICAgIC5waXBlKHNwbGl0KCkpXG4gICAgLnBpcGUoY29sb3IoJ3llbGxvdycpKVxuICAgIC5waXBlKHByZWZpeExpbmVzKGAke3NlcnZpY2VOYW1lfSB8IGApKVxuICAgIC5waXBlKHByb2Nlc3Muc3Rkb3V0KVxuICBwLnN0ZGVyclxuICAgIC5waXBlKHNwbGl0KCkpXG4gICAgLnBpcGUoY29sb3IoJ3JlZCcpKVxuICAgIC5waXBlKHByZWZpeExpbmVzKGAke3NlcnZpY2VOYW1lfSB8IGApKVxuICAgIC5waXBlKHByb2Nlc3Muc3RkZXJyKVxuICBwXG4gICAgLm9uKCdlcnJvcicsIHJlamVjdClcbiAgICAub24oJ2Nsb3NlJywgZXhpdENvZGUgPT4gZXhpdENvZGUgPT09IDAgPyByZXNvbHZlKCkgOiByZWplY3QoZXhpdENvZGUpKVxufSlcblxuY29uc3QgcmVtb3ZlRGFuZ2xpbmcgPSAoaW1hZ2VzVGhhdE1hdGNoZWRUYWdzKSA9PiB7XG4gIHJldHVybiBQcm9taXNlLmFsbChpbWFnZXNUaGF0TWF0Y2hlZFRhZ3NcbiAgICAubWFwKGltYWdlID0+IGdldEltYWdlKGltYWdlLklkKS50aGVuKGluZm8gPT4ge1xuICAgICAgaWYgKCFpbmZvLlJlcG9UYWdzLmxlbmd0aCkgeyAvLyBubyBsb25nZXIgdGFnZ2VkIChpcyBkYW5nbGluZylcbiAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoXG4gICAgICAgICAgYFJlbW92aW5nIGRhbmdsaW5nIGltYWdlICR7aW5mby5JZH0sIHByZXZpb3VzbHkgdGFnZ2VkIFwiJHtpbWFnZS5SZXBvVGFncy5qb2luKCcgJyl9XCJcXG5gXG4gICAgICAgIClcbiAgICAgICAgcmV0dXJuIHJtaShpbmZvLklkKVxuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgfSkpXG4gIClcbn1cblxuY29uc3QgYnVpbGRJbWFnZUFuZFJlbW92ZURhbmdsaW5nID0gYXN5bmMgKHNlcnZpY2VOYW1lLCBpbWFnZSkgPT4ge1xuICBjb25zdCBpbWFnZXNUaGF0TWF0Y2hUYWdzID0gYXdhaXQgUHJvbWlzZS5hbGwoaW1hZ2UudGFncy5tYXAodGFnID0+IGdldEltYWdlKHRhZykpKVxuICBjb25zdCBpbWFnZUlkc1RoYXRNYXRjaFRhZ3MgPSBpbWFnZXNUaGF0TWF0Y2hUYWdzLm1hcChpbmZvID0+IGluZm8uSWQpXG4gIGF3YWl0IGJ1aWxkSW1hZ2Uoc2VydmljZU5hbWUsIGltYWdlKVxuICBhd2FpdCByZW1vdmVEYW5nbGluZyhpbWFnZXNUaGF0TWF0Y2hUYWdzKVxuICByZXR1cm5cbn1cblxuY29uc3QgYnVpbGRJbWFnZXMgPSB0b0J1aWxkID0+IHtcbiAgdHJ5IHtcbiAgICB0b0J1aWxkLmZvckVhY2goKFtuYW1lLCBpbWFnZXNdKSA9PiB7XG4gICAgICBpbWFnZXMuZm9yRWFjaChpbWFnZSA9PiB7XG4gICAgICAgIGlmICghKGltYWdlLmZpbGUgJiYgaW1hZ2UuZmlsZS5sZW5ndGgpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBubyBEb2NrZXJmaWxlIHBhdGggZ2l2ZW4gZm9yIFwiJHtuYW1lfVwiIHNlcnZpY2UgaW1hZ2VgKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG4gIH1cbiAgY2F0Y2ggKGVycikge1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpXG4gIH1cbiAgcmV0dXJuIHRvQnVpbGQucmVkdWNlKChwcm9taXNlLCBbbmFtZSwgaW1hZ2VzXSkgPT4ge1xuICAgIHJldHVybiBwcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGltYWdlcy5yZWR1Y2UoKHByb21pc2UsIGltYWdlKSA9PiB7XG4gICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oKCkgPT4gYnVpbGRJbWFnZUFuZFJlbW92ZURhbmdsaW5nKG5hbWUsIGltYWdlKSlcbiAgICAgIH0sIFByb21pc2UucmVzb2x2ZSgpKVxuICAgIH0pXG4gIH0sIFByb21pc2UucmVzb2x2ZSgpKVxufVxuXG5jb25zdCBidWlsZCA9IChjb25maWcsIHtzZXJ2aWNlcyA9IFtdfSkgPT4ge1xuICBjb25zdCBzZWxlY3RlZFNlcnZpY2VzID0gUi5pZkVsc2UoXG4gICAgKCkgPT4gUi5pc0VtcHR5KHNlcnZpY2VzKSwgLy8gbm8gc2VydmljZXMgc3BlY2lmaWVkXG4gICAgKCkgPT4gY29uZmlnLnNlcnZpY2VzLCAvLyB1c2UgYWxsIG9mIHRoZW1cbiAgICAoKSA9PiBSLnBpcGUoIC8vIGZpbHRlciBjb25maWcgZG93biB0byBnaXZlbiBzZXJ2aWNlc1xuICAgICAgUi50b1BhaXJzLFxuICAgICAgUi5maWx0ZXIoKFtuYW1lXSkgPT4gc2VydmljZXMuaW5jbHVkZXMobmFtZSkpLFxuICAgICAgUi5mcm9tUGFpcnNcbiAgICApKGNvbmZpZy5zZXJ2aWNlcylcbiAgKSgpXG4gIGNvbnN0IHRvQnVpbGQgPSBSLnBpcGUoXG4gICAgUi50b1BhaXJzLFxuICAgIC8vIGp1c3QgaGFuZGxlIGltYWdlIHByb3BlcnR5XG4gICAgUi5tYXAoKFtuYW1lLCB2YWx1ZV0pID0+IFtuYW1lLCB2YWx1ZS5pbWFnZV0pLFxuICAgIC8vIGZpbHRlciBvdXQgaW1hZ2Ugc2V0dGluZ3MgdGhhdCBhcmUgc3RyaW5ncyAobm90aGluZyB0byBidWlsZClcbiAgICBSLmZpbHRlcigoW25hbWUsIHZhbHVlXSkgPT4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJyksXG4gICAgLy8gbm9ybWFsaXplIHRvIGFycmF5IG9mIG9iamVjdHMgcmF0aGVyIHRoYW4gaGF2aW5nIHRvIGNoZWNrIGZvciBhcnJheS9vYmplY3QgaW4gZnVydGhlciBjb2RlXG4gICAgLy8gICBiZWNhdXNlIHRoZSBpbWFnZSBzZXR0aW5nIGNhbiBzcGVjaWZ5IG11bHRpcGxlIGltYWdlcyB0byBidWlsZFxuICAgIFIubWFwKChbbmFtZSwgdmFsdWVdKSA9PiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IFtuYW1lLCB2YWx1ZV0gOiBbbmFtZSwgW3ZhbHVlXV0pLFxuICAgIC8vIG5vcm1hbGl6ZSBpbWFnZS50YWcgdG8gYXJyYXlcbiAgICBSLm1hcCgoW25hbWUsIGltYWdlc10pID0+IFtcbiAgICAgIG5hbWUsXG4gICAgICBpbWFnZXMubWFwKGltYWdlID0+IFIub3ZlcihcbiAgICAgICAgUi5sZW5zUHJvcCgndGFncycpLFxuICAgICAgICAoeCA9PiBBcnJheS5pc0FycmF5KHgpID8geCA6IFt4XSksXG4gICAgICAgIGltYWdlXG4gICAgICApKVxuICAgIF0pXG4gICkoc2VsZWN0ZWRTZXJ2aWNlcylcbiAgcmV0dXJuIGJ1aWxkSW1hZ2VzKHRvQnVpbGQpXG59XG5cbm1vZHVsZS5leHBvcnRzID0gYnVpbGRcbiJdfQ==