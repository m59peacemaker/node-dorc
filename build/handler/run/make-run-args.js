var _require = require('path');

const joinPath = _require.join,
      isAbsolutePath = _require.isAbsolute;

var _require2 = require('os');

const getHomedir = _require2.homedir;

const R = require('ramda');
const expandTilde = require('expand-tilde');
const moveProps = require('../../lib/move-props');
const mergeProps = require('../../lib/merge-props');
const transformDockerOptions = require('../../lib/transform-docker-options');
const dockerOptionsToArray = require('./docker-options-to-array');
const getMainTag = require('../../lib/get-main-tag');

const ensureArray = R.unless(R.isArrayLike, R.of);

const dorcServiceProps = ['image', 'cmd'];

const propTransforms = {
  volumes: (value, prop, dirs) => {
    return value.map(v => {
      v = expandTilde(v, dirs.homedir);
      if (!isAbsolutePath(v)) {
        return ['-v', joinPath(dirs.cwd, v)];
      } else {
        return ['-v', v];
      }
    });
  },
  env: value => R.toPairs(value).map(([k, v]) => ['-e', `${ k }=${ v }`]),
  ports: value => value.map(v => ['-p', v])
};

const renameKeys = R.curry((keysMap, obj) => R.reduce((acc, key) => R.assoc(keysMap[key] || key, obj[key], acc), {}, R.keys(obj)));

const propOrPath = R.ifElse(R.isArrayLike, R.path, R.prop);
const propsOrPaths = items => R.juxt(R.map(propOrPath, items));
const concatAll = R.reduce(R.concat, []);
const removeNil = R.reject(R.isNil);

const findCmd = (a, b) => b.cmd && b.cmd.length ? b.cmd : a.cmd || [];

const makeRunArgs = (service, // similiar to `args.docker` but with additional properties like `image`
args = {}, // {docker: {env: 'FOO=foo', net: 'host'} cmd: [...commandParts]}
dirs = {
  cwd: process.cwd(),
  homedir: getHomedir()
}) => {
  return R.pipe(
  // move props that aren't for docker run from "service.config" to "dorcRunProps"
  R.converge(R.assoc('dorcRunProps'), [R.pipe(R.path(['service', 'config']), R.pick(dorcServiceProps)), R.identity]),
  // the rest are docker run options
  R.converge(R.assoc('dockerRunOptions'), [R.pipe(R.path(['service', 'config']), R.omit(dorcServiceProps), transformDockerOptions(propTransforms, dirs)), R.identity]), R.over(R.lensPath(['args', 'docker']), dockerOptionsToArray),
  // concat "args.docker" to "dockerRunOptions"
  R.converge(R.assoc('dockerRunOptions'), [R.pipe(propsOrPaths(['dockerRunOptions', ['args', 'docker']]), concatAll), R.identity]),
  // concat "dockerRunOptions", "image", "cmd"
  R.converge(R.unapply(R.reduce(R.concat, [])), [R.prop('dockerRunOptions'), R.pipe(R.path(['dorcRunProps', 'image']), getMainTag, ensureArray), R.converge(findCmd, [R.prop('dorcRunProps'), R.prop('args')])]))({ service, args });
};

module.exports = makeRunArgs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9oYW5kbGVyL3J1bi9tYWtlLXJ1bi1hcmdzLmpzIl0sIm5hbWVzIjpbInJlcXVpcmUiLCJqb2luUGF0aCIsImpvaW4iLCJpc0Fic29sdXRlUGF0aCIsImlzQWJzb2x1dGUiLCJnZXRIb21lZGlyIiwiaG9tZWRpciIsIlIiLCJleHBhbmRUaWxkZSIsIm1vdmVQcm9wcyIsIm1lcmdlUHJvcHMiLCJ0cmFuc2Zvcm1Eb2NrZXJPcHRpb25zIiwiZG9ja2VyT3B0aW9uc1RvQXJyYXkiLCJnZXRNYWluVGFnIiwiZW5zdXJlQXJyYXkiLCJ1bmxlc3MiLCJpc0FycmF5TGlrZSIsIm9mIiwiZG9yY1NlcnZpY2VQcm9wcyIsInByb3BUcmFuc2Zvcm1zIiwidm9sdW1lcyIsInZhbHVlIiwicHJvcCIsImRpcnMiLCJtYXAiLCJ2IiwiY3dkIiwiZW52IiwidG9QYWlycyIsImsiLCJwb3J0cyIsInJlbmFtZUtleXMiLCJjdXJyeSIsImtleXNNYXAiLCJvYmoiLCJyZWR1Y2UiLCJhY2MiLCJrZXkiLCJhc3NvYyIsImtleXMiLCJwcm9wT3JQYXRoIiwiaWZFbHNlIiwicGF0aCIsInByb3BzT3JQYXRocyIsIml0ZW1zIiwianV4dCIsImNvbmNhdEFsbCIsImNvbmNhdCIsInJlbW92ZU5pbCIsInJlamVjdCIsImlzTmlsIiwiZmluZENtZCIsImEiLCJiIiwiY21kIiwibGVuZ3RoIiwibWFrZVJ1bkFyZ3MiLCJzZXJ2aWNlIiwiYXJncyIsInByb2Nlc3MiLCJwaXBlIiwiY29udmVyZ2UiLCJwaWNrIiwiaWRlbnRpdHkiLCJvbWl0Iiwib3ZlciIsImxlbnNQYXRoIiwidW5hcHBseSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJlQUdJQSxRQUFRLE1BQVIsQzs7TUFGSUMsUSxZQUFOQyxJO01BQ1lDLGMsWUFBWkMsVTs7Z0JBRTRCSixRQUFRLElBQVIsQzs7TUFBZEssVSxhQUFUQyxPOztBQUNQLE1BQU1DLElBQUlQLFFBQVEsT0FBUixDQUFWO0FB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QUMsY0FBRCxFQUFpQixPQUFqQixDQUFQLENBQVAsRUFBMEM3QixVQUExQyxFQUFzREMsV0FBdEQsQ0FGNEMsRUFHNUNQLEVBQUVzRCxRQUFGLENBQVdWLE9BQVgsRUFBb0IsQ0FBQzVDLEVBQUVlLElBQUYsQ0FBTyxjQUFQLENBQUQsRUFBeUJmLEVBQUVlLElBQUYsQ0FBTyxNQUFQLENBQXpCLENBQXBCLENBSDRDLENBQTlDLENBdEJLLEVBMkJMLEVBQUNtQyxPQUFELEVBQVVDLElBQVYsRUEzQkssQ0FBUDtBQTRCRCxDQXBDRDs7QUFzQ0FVLE9BQU9DLE9BQVAsR0FBaUJiLFdBQWpCIiwiZmlsZSI6Im1ha2UtcnVuLWFyZ3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7XG4gIGpvaW46IGpvaW5QYXRoLFxuICBpc0Fic29sdXRlOiBpc0Fic29sdXRlUGF0aFxufSA9IHJlcXVpcmUoJ3BhdGgnKVxuY29uc3Qge2hvbWVkaXI6IGdldEhvbWVkaXJ9ID0gcmVxdWlyZSgnb3MnKVxuY29uc3QgUiA9IHJlcXVpcmUoJ3JhbWRhJylcbmNvbnN0IGV4cGFuZFRpbGRlID0gcmVxdWlyZSgnZXhwYW5kLXRpbGRlJylcbmNvbnN0IG1vdmVQcm9wcyA9IHJlcXVpcmUoJ34vbGliL21vdmUtcHJvcHMnKVxuY29uc3QgbWVyZ2VQcm9wcyA9IHJlcXVpcmUoJ34vbGliL21lcmdlLXByb3BzJylcbmNvbnN0IHRyYW5zZm9ybURvY2tlck9wdGlvbnMgPSByZXF1aXJlKCd+L2xpYi90cmFuc2Zvcm0tZG9ja2VyLW9wdGlvbnMnKVxuY29uc3QgZG9ja2VyT3B0aW9uc1RvQXJyYXkgPSByZXF1aXJlKCcuL2RvY2tlci1vcHRpb25zLXRvLWFycmF5JylcbmNvbnN0IGdldE1haW5UYWcgPSByZXF1aXJlKCd+L2xpYi9nZXQtbWFpbi10YWcnKVxuXG5jb25zdCBlbnN1cmVBcnJheSA9IFIudW5sZXNzKFIuaXNBcnJheUxpa2UsIFIub2YpXG5cbmNvbnN0IGRvcmNTZXJ2aWNlUHJvcHMgPSBbXG4gICdpbWFnZScsXG4gICdjbWQnXG5dXG5cbmNvbnN0IHByb3BUcmFuc2Zvcm1zID0ge1xuICB2b2x1bWVzOiAodmFsdWUsIHByb3AsIGRpcnMpID0+IHtcbiAgICByZXR1cm4gdmFsdWUubWFwKHYgPT4ge1xuICAgICAgdiA9IGV4cGFuZFRpbGRlKHYsIGRpcnMuaG9tZWRpcilcbiAgICAgIGlmICghaXNBYnNvbHV0ZVBhdGgodikpIHtcbiAgICAgICAgcmV0dXJuIFsnLXYnLCBqb2luUGF0aChkaXJzLmN3ZCwgdildXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gWyctdicsIHZdXG4gICAgICB9XG4gICAgfSlcbiAgfSxcbiAgZW52OiB2YWx1ZSA9PiBSLnRvUGFpcnModmFsdWUpLm1hcCgoW2ssIHZdKSA9PiBbJy1lJywgYCR7a309JHt2fWBdKSxcbiAgcG9ydHM6IHZhbHVlID0+IHZhbHVlLm1hcCh2ID0+IFsnLXAnLCB2XSlcbn1cblxuY29uc3QgcmVuYW1lS2V5cyA9IFIuY3VycnkoKGtleXNNYXAsIG9iaikgPT5cbiAgUi5yZWR1Y2UoKGFjYywga2V5KSA9PiBSLmFzc29jKGtleXNNYXBba2V5XSB8fCBrZXksIG9ialtrZXldLCBhY2MpLCB7fSwgUi5rZXlzKG9iaikpXG4pXG5cbmNvbnN0IHByb3BPclBhdGggPSBSLmlmRWxzZShSLmlzQXJyYXlMaWtlLCBSLnBhdGgsIFIucHJvcClcbmNvbnN0IHByb3BzT3JQYXRocyA9IGl0ZW1zID0+IFIuanV4dChSLm1hcChwcm9wT3JQYXRoLCBpdGVtcykpXG5jb25zdCBjb25jYXRBbGwgPSBSLnJlZHVjZShSLmNvbmNhdCwgW10pXG5jb25zdCByZW1vdmVOaWwgPSBSLnJlamVjdChSLmlzTmlsKVxuXG5jb25zdCBmaW5kQ21kID0gKGEsIGIpID0+IChiLmNtZCAmJiBiLmNtZC5sZW5ndGgpID8gYi5jbWQgOiAoYS5jbWQgfHwgW10pXG5cbmNvbnN0IG1ha2VSdW5BcmdzID0gKFxuICBzZXJ2aWNlLCAvLyBzaW1pbGlhciB0byBgYXJncy5kb2NrZXJgIGJ1dCB3aXRoIGFkZGl0aW9uYWwgcHJvcGVydGllcyBsaWtlIGBpbWFnZWBcbiAgYXJncyA9IHt9LCAvLyB7ZG9ja2VyOiB7ZW52OiAnRk9PPWZvbycsIG5ldDogJ2hvc3QnfSBjbWQ6IFsuLi5jb21tYW5kUGFydHNdfVxuICBkaXJzID0ge1xuICAgIGN3ZDogcHJvY2Vzcy5jd2QoKSxcbiAgICBob21lZGlyOiBnZXRIb21lZGlyKClcbiAgfVxuKSA9PiB7XG4gIHJldHVybiBSLnBpcGUoXG4gICAgLy8gbW92ZSBwcm9wcyB0aGF0IGFyZW4ndCBmb3IgZG9ja2VyIHJ1biBmcm9tIFwic2VydmljZS5jb25maWdcIiB0byBcImRvcmNSdW5Qcm9wc1wiXG4gICAgUi5jb252ZXJnZShSLmFzc29jKCdkb3JjUnVuUHJvcHMnKSwgW1xuICAgICAgUi5waXBlKFIucGF0aChbJ3NlcnZpY2UnLCAnY29uZmlnJ10pLCBSLnBpY2soZG9yY1NlcnZpY2VQcm9wcykpLFxuICAgICAgUi5pZGVudGl0eVxuICAgIF0pLFxuICAgIC8vIHRoZSByZXN0IGFyZSBkb2NrZXIgcnVuIG9wdGlvbnNcbiAgICBSLmNvbnZlcmdlKFIuYXNzb2MoJ2RvY2tlclJ1bk9wdGlvbnMnKSwgW1xuICAgICAgUi5waXBlKFxuICAgICAgICBSLnBhdGgoWydzZXJ2aWNlJywgJ2NvbmZpZyddKSxcbiAgICAgICAgUi5vbWl0KGRvcmNTZXJ2aWNlUHJvcHMpLFxuICAgICAgICB0cmFuc2Zvcm1Eb2NrZXJPcHRpb25zKHByb3BUcmFuc2Zvcm1zLCBkaXJzKVxuICAgICAgKSxcbiAgICAgIFIuaWRlbnRpdHlcbiAgICBdKSxcbiAgICBSLm92ZXIoUi5sZW5zUGF0aChbJ2FyZ3MnLCAnZG9ja2VyJ10pLCBkb2NrZXJPcHRpb25zVG9BcnJheSksXG4gICAgLy8gY29uY2F0IFwiYXJncy5kb2NrZXJcIiB0byBcImRvY2tlclJ1bk9wdGlvbnNcIlxuICAgIFIuY29udmVyZ2UoUi5hc3NvYygnZG9ja2VyUnVuT3B0aW9ucycpLCBbXG4gICAgICBSLnBpcGUocHJvcHNPclBhdGhzKFsnZG9ja2VyUnVuT3B0aW9ucycsIFsnYXJncycsICdkb2NrZXInXV0pLCBjb25jYXRBbGwpLFxuICAgICAgUi5pZGVudGl0eVxuICAgIF0pLFxuICAgIC8vIGNvbmNhdCBcImRvY2tlclJ1bk9wdGlvbnNcIiwgXCJpbWFnZVwiLCBcImNtZFwiXG4gICAgUi5jb252ZXJnZShSLnVuYXBwbHkoUi5yZWR1Y2UoUi5jb25jYXQsIFtdKSksIFtcbiAgICAgIFIucHJvcCgnZG9ja2VyUnVuT3B0aW9ucycpLFxuICAgICAgUi5waXBlKFIucGF0aChbJ2RvcmNSdW5Qcm9wcycsICdpbWFnZSddKSwgZ2V0TWFpblRhZywgZW5zdXJlQXJyYXkpLFxuICAgICAgUi5jb252ZXJnZShmaW5kQ21kLCBbUi5wcm9wKCdkb3JjUnVuUHJvcHMnKSwgUi5wcm9wKCdhcmdzJyldKSxcbiAgICBdKVxuICApKHtzZXJ2aWNlLCBhcmdzfSlcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBtYWtlUnVuQXJnc1xuIl19