var _require = require('child_process');

const exec = _require.exec,
      execSync = _require.execSync,
      spawn = _require.spawn;

const util = require('util');
const docker = require('../../lib/docker-api');

var _require2 = require('../../test');

const test = _require2.test,
      cmd = _require2.cmd,
      tmpDir = _require2.tmpDir,
      setup = _require2.setup,
      cleanup = _require2.cleanup,
      execAsync = _require2.execAsync,
      execFileAsync = _require2.execFileAsync;


test('"run {service}" runs service with default command', t => {
  t.plan(1);
  const config = `
    services:
      hello:
        image: pmkr/hello:1.0
  `;
  setup(config);
  execAsync(`${ cmd } run hello`, { cwd: tmpDir }).then(([stdout, stderr]) => {
    console.log('stdout:', stdout);
    console.error('stderr:', stderr);
    if (stderr === '' && stdout.split('\n').includes('Hello, World!')) {
      t.pass();
    } else {
      t.fail('Wrong output');
    }
  }).catch(t.fail).then(cleanup);
});

test('"run {service} {cmd}" runs service with {cmd}"', t => {
  t.plan(1);
  const config = `
    services:
      hello:
        image: pmkr/hello:1.0
  `;
  setup(config);
  execAsync(`${ cmd } run hello Darkness, my old friend`, { cwd: tmpDir }).then(([stdout, stderr]) => {
    if (stderr === '' && stdout.split('\n').includes('Hello, Darkness, my old friend')) {
      t.pass();
    } else {
      console.log('stdout:', stdout);
      console.error('stderr:', stderr);
      t.fail('Wrong output');
    }
  }).catch(t.fail).then(cleanup);
});

test('multi-line, complicated, quote-ridden command', t => {
  t.plan(1);
  const config = `
    services:
      foo:
        image: alpine
        entrypoint: /bin/sh
  `;
  setup(config);
  const lines = Array(3).fill(true).map((_, i) => i + 1).join('\n');
  const shCmd = `${ cmd } run foo -c "printf '${ lines }'"`;
  execAsync(shCmd, { cwd: tmpDir }).then(([stdout, stderr]) => {
    console.log('stdout:\n', util.inspect(stdout));
    console.log(util.inspect(lines));
    if (stderr.length) {
      t.fail(util.inspect(stderr));
    } else {
      t.equal(stdout.split('\n').slice(-3).join(''), '123');
    }
  }).catch(t.fail).then(cleanup);
});

test('"dorc run" accepts "docker run" options', t => {
  t.plan(1);
  const config = `
    services:
      foo:
        image: alpine
        cmd: /bin/sh -c "printf \\"$FOO\\""
  `;
  setup(config);
  execFileAsync(cmd, ['run', '--rm', '-e', 'FOO=yo dud', 'foo'], { cwd: tmpDir }).then(([stdout, stderr]) => {
    console.log(stdout, stderr);
    const lines = stdout.split('\n');
    t.equal(lines.slice(-1).join(''), 'yo dud');
  }).catch(t.fail).then(cleanup);
});

test('"dorc run" uses command from cli args', t => {
  t.plan(1);
  const config = `
    services:
      foo:
        image: alpine
        env:
          FOO: yo dud
        cmd: printf "fail"
  `;
  setup(config);
  execFileAsync(cmd, ['run', '--rm', '-e', 'FOO=yo dud', 'foo', '/bin/sh', '-c', 'printf "$FOO"'], { cwd: tmpDir }).then(([stdout, stderr]) => {
    console.log(stdout, stderr);
    const lines = stdout.split('\n');
    t.equal(lines.slice(-1).join(''), 'yo dud');
  }).catch(t.fail).then(cleanup);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9oYW5kbGVyL3J1bi9jbWQudGVzdC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiZXhlYyIsImV4ZWNTeW5jIiwic3Bhd24iLCJ1dGlsIiwiZG9ja2VyIiwidGVzdCIsImNtZCIsInRtcERpciIsInNldHVwIiwiY2xlYW51cCIsImV4ZWNBc3luYyIsImV4ZWNGaWxlQXN5bmMiLCJ0IiwicGxhbiIsImNvbmZpZyIsImN3ZCIsInRoZW4iLCJzdGRvdXQiLCJzdGRlcnIiLCJjb25zb2xlIiwibG9nIiwiZXJyb3IiLCJzcGxpdCIsImluY2x1ZGVzIiwicGFzcyIsImZhaWwiLCJjYXRjaCIsImxpbmVzIiwiQXJyYXkiLCJmaWxsIiwibWFwIiwiXyIsImkiLCJqb2luIiwic2hDbWQiLCJpbnNwZWN0IiwibGVuZ3RoIiwiZXF1YWwiLCJzbGljZSJdLCJtYXBwaW5ncyI6ImVBQWdDQSxRQUFRLGVBQVIsQzs7TUFBekJDLEksWUFBQUEsSTtNQUFNQyxRLFlBQUFBLFE7TUFBVUMsSyxZQUFBQSxLOztBQUN2QixNQUFNQyxPQUFPSixRQUFRLE1BQVIsQ0FBYjtBQUNBLE1BQU1LLFNBQVNMLFFBQVEsc0JBQVIsQ0FBZjs7Z0JBU0lBLFFBQVEsWUFBUixDOztNQVBGTSxJLGFBQUFBLEk7TUFDQUMsRyxhQUFBQSxHO01BQ0FDLE0sYUFBQUEsTTtNQUNBQyxLLGFBQUFBLEs7TUFDQUMsTyxhQUFBQSxPO01BQ0FDLFMsYUFBQUEsUztNQUNBQyxhLGFBQUFBLGE7OztBQUdGTixLQUFLLG1EQUFMLEVBQTBETyxLQUFLO0FBQzdEQSxJQUFFQyxJQUFGLENBQU8sQ0FBUDtBQUNBLFFBQU1DLFNBQVU7Ozs7R0FBaEI7QUFLQU4sUUFBTU0sTUFBTjtBQUNBSixZQUFXLElBQUVKLEdBQUksYUFBakIsRUFBOEIsRUFBQ1MsS0FBS1IsTUFBTixFQUE5QixFQUNHUyxJQURILENBQ1EsQ0FBQyxDQUFDQyxNQUFELEVBQVNDLE1BQVQsQ0FBRCxLQUFzQjtBQUMxQkMsWUFB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dGVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHtleGVjLCBleGVjU3luYywgc3Bhd259ID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpXG5jb25zdCB1dGlsID0gcmVxdWlyZSgndXRpbCcpXG5jb25zdCBkb2NrZXIgPSByZXF1aXJlKCd+L2xpYi9kb2NrZXItYXBpJylcbmNvbnN0IHtcbiAgdGVzdCxcbiAgY21kLFxuICB0bXBEaXIsXG4gIHNldHVwLFxuICBjbGVhbnVwLFxuICBleGVjQXN5bmMsXG4gIGV4ZWNGaWxlQXN5bmNcbn0gPSByZXF1aXJlKCd+L3Rlc3QnKVxuXG50ZXN0KCdcInJ1biB7c2VydmljZX1cIiBydW5zIHNlcnZpY2Ugd2l0aCBkZWZhdWx0IGNvbW1hbmQnLCB0ID0+IHtcbiAgdC5wbGFuKDEpXG4gIGNvbnN0IGNvbmZpZyA9IGBcbiAgICBzZXJ2aWNlczpcbiAgICAgIGhlbGxvOlxuICAgICAgICBpbWFnZTogcG1rci9oZWxsbzoxLjBcbiAgYFxuICBzZXR1cChjb25maWcpXG4gIGV4ZWNBc3luYyhgJHtjbWR9IHJ1biBoZWxsb2AsIHtjd2Q6IHRtcERpcn0pXG4gICAgLnRoZW4oKFtzdGRvdXQsIHN0ZGVycl0pID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdzdGRvdXQ6Jywgc3Rkb3V0KVxuICAgICAgY29uc29sZS5lcnJvcignc3RkZXJyOicsIHN0ZGVycilcbiAgICAgIGlmIChzdGRlcnIgPT09ICcnICYmIHN0ZG91dC5zcGxpdCgnXFxuJykuaW5jbHVkZXMoJ0hlbGxvLCBXb3JsZCEnKSkge1xuICAgICAgICB0LnBhc3MoKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdC5mYWlsKCdXcm9uZyBvdXRwdXQnKVxuICAgICAgfVxuICAgIH0pXG4gICAgLmNhdGNoKHQuZmFpbClcbiAgICAudGhlbihjbGVhbnVwKVxufSlcblxudGVzdCgnXCJydW4ge3NlcnZpY2V9IHtjbWR9XCIgcnVucyBzZXJ2aWNlIHdpdGgge2NtZH1cIicsIHQgPT4ge1xuICB0LnBsYW4oMSlcbiAgY29uc3QgY29uZmlnID0gYFxuICAgIHNlcnZpY2VzOlxuICAgICAgaGVsbG86XG4gICAgICAgIGltYWdlOiBwbWtyL2hlbGxvOjEuMFxuICBgXG4gIHNldHVwKGNvbmZpZylcbiAgZXhlY0FzeW5jKGAke2NtZH0gcnVuIGhlbGxvIERhcmtuZXNzLCBteSBvbGQgZnJpZW5kYCwge2N3ZDogdG1wRGlyfSlcbiAgICAudGhlbigoW3N0ZG91dCwgc3RkZXJyXSkgPT4ge1xuICAgICAgaWYgKHN0ZGVyciA9PT0gJycgJiYgc3Rkb3V0LnNwbGl0KCdcXG4nKS5pbmNsdWRlcygnSGVsbG8sIERhcmtuZXNzLCBteSBvbGQgZnJpZW5kJykpIHtcbiAgICAgICAgdC5wYXNzKClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdzdGRvdXQ6Jywgc3Rkb3V0KVxuICAgICAgICBjb25zb2xlLmVycm9yKCdzdGRlcnI6Jywgc3RkZXJyKVxuICAgICAgICB0LmZhaWwoJ1dyb25nIG91dHB1dCcpXG4gICAgICB9XG4gICAgfSlcbiAgICAuY2F0Y2godC5mYWlsKVxuICAgIC50aGVuKGNsZWFudXApXG59KVxuXG50ZXN0KCdtdWx0aS1saW5lLCBjb21wbGljYXRlZCwgcXVvdGUtcmlkZGVuIGNvbW1hbmQnLCB0ID0+IHtcbiAgdC5wbGFuKDEpXG4gIGNvbnN0IGNvbmZpZyA9IGBcbiAgICBzZXJ2aWNlczpcbiAgICAgIGZvbzpcbiAgICAgICAgaW1hZ2U6IGFscGluZVxuICAgICAgICBlbnRyeXBvaW50OiAvYmluL3NoXG4gIGBcbiAgc2V0dXAoY29uZmlnKVxuICBjb25zdCBsaW5lcyA9IEFycmF5KDMpLmZpbGwodHJ1ZSkubWFwKChfLCBpKSA9PiBpICsgMSkuam9pbignXFxuJylcbiAgY29uc3Qgc2hDbWQgPSBgJHtjbWR9IHJ1biBmb28gLWMgXCJwcmludGYgJyR7bGluZXN9J1wiYFxuICBleGVjQXN5bmMoc2hDbWQsIHtjd2Q6IHRtcERpcn0pXG4gICAgLnRoZW4oKFtzdGRvdXQsIHN0ZGVycl0pID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdzdGRvdXQ6XFxuJywgdXRpbC5pbnNwZWN0KHN0ZG91dCkpXG4gICAgICBjb25zb2xlLmxvZyh1dGlsLmluc3BlY3QobGluZXMpKVxuICAgICAgaWYgKHN0ZGVyci5sZW5ndGgpIHtcbiAgICAgICAgdC5mYWlsKHV0aWwuaW5zcGVjdChzdGRlcnIpKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdC5lcXVhbChzdGRvdXQuc3BsaXQoJ1xcbicpLnNsaWNlKC0zKS5qb2luKCcnKSwgJzEyMycpXG4gICAgICB9XG4gICAgfSlcbiAgICAuY2F0Y2godC5mYWlsKVxuICAgIC50aGVuKGNsZWFudXApXG59KVxuXG50ZXN0KCdcImRvcmMgcnVuXCIgYWNjZXB0cyBcImRvY2tlciBydW5cIiBvcHRpb25zJywgdCA9PiB7XG4gIHQucGxhbigxKVxuICBjb25zdCBjb25maWcgPSBgXG4gICAgc2VydmljZXM6XG4gICAgICBmb286XG4gICAgICAgIGltYWdlOiBhbHBpbmVcbiAgICAgICAgY21kOiAvYmluL3NoIC1jIFwicHJpbnRmIFxcXFxcIiRGT09cXFxcXCJcIlxuICBgXG4gIHNldHVwKGNvbmZpZylcbiAgZXhlY0ZpbGVBc3luYyhjbWQsIFsncnVuJywgJy0tcm0nLCAnLWUnLCAnRk9PPXlvIGR1ZCcsICdmb28nXSwge2N3ZDogdG1wRGlyfSlcbiAgICAudGhlbigoW3N0ZG91dCwgc3RkZXJyXSkgPT4ge1xuICAgICAgY29uc29sZS5sb2coc3Rkb3V0LCBzdGRlcnIpXG4gICAgICBjb25zdCBsaW5lcyA9IHN0ZG91dC5zcGxpdCgnXFxuJylcbiAgICAgIHQuZXF1YWwobGluZXMuc2xpY2UoLTEpLmpvaW4oJycpLCAneW8gZHVkJylcbiAgICB9KVxuICAgIC5jYXRjaCh0LmZhaWwpXG4gICAgLnRoZW4oY2xlYW51cClcbn0pXG5cbnRlc3QoJ1wiZG9yYyBydW5cIiB1c2VzIGNvbW1hbmQgZnJvbSBjbGkgYXJncycsIHQgPT4ge1xuICB0LnBsYW4oMSlcbiAgY29uc3QgY29uZmlnID0gYFxuICAgIHNlcnZpY2VzOlxuICAgICAgZm9vOlxuICAgICAgICBpbWFnZTogYWxwaW5lXG4gICAgICAgIGVudjpcbiAgICAgICAgICBGT086IHlvIGR1ZFxuICAgICAgICBjbWQ6IHByaW50ZiBcImZhaWxcIlxuICBgXG4gIHNldHVwKGNvbmZpZylcbiAgZXhlY0ZpbGVBc3luYyhjbWQsIFsncnVuJywgJy0tcm0nLCAnLWUnLCAnRk9PPXlvIGR1ZCcsICdmb28nLCAnL2Jpbi9zaCcsICctYycsICdwcmludGYgXCIkRk9PXCInXSwge2N3ZDogdG1wRGlyfSlcbiAgICAudGhlbigoW3N0ZG91dCwgc3RkZXJyXSkgPT4ge1xuICAgICAgY29uc29sZS5sb2coc3Rkb3V0LCBzdGRlcnIpXG4gICAgICBjb25zdCBsaW5lcyA9IHN0ZG91dC5zcGxpdCgnXFxuJylcbiAgICAgIHQuZXF1YWwobGluZXMuc2xpY2UoLTEpLmpvaW4oJycpLCAneW8gZHVkJylcbiAgICB9KVxuICAgIC5jYXRjaCh0LmZhaWwpXG4gICAgLnRoZW4oY2xlYW51cClcbn0pXG4iXX0=