function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const R = require('ramda');

var _require = require('child_process');

const spawn = _require.spawn,
      exec = _require.exec;

const format = require('chalk');
const split = require('split');
const prefixLines = require('prefix-stream-lines');
const through = require('throo');
const docker = require('../docker-api');

const color = c => {
  return through((push, chunk, enc, cb) => {
    push(format[c](chunk) + '\n');
    cb();
  });
};

const _buildImage = ({ file, context = './', tags = [], args = [] }) => {
  const tagArgs = R.flatten(tags.map(tag => ['-t', tag]));
  const buildArgs = R.pipe(R.toPairs, R.map(([key, value]) => ['--build-arg', `${ key }=${ value }`]), R.flatten)(args);
  const dockerArgs = ['build', ...tagArgs, ...buildArgs, '-f', file, context];
  process.stdout.write(`  > docker ${ dockerArgs.join(' ') }\n`);
  return spawn('docker', dockerArgs);
};

const buildImage = (serviceName, image) => new Promise((resolve, reject) => {
  const p = _buildImage(image);
  p.stdout.pipe(split()).pipe(color('yellow')).pipe(prefixLines(`${ serviceName } | `)).pipe(process.stdout);
  p.stderr.pipe(split()).pipe(color('red')).pipe(prefixLines(`${ serviceName } | `)).pipe(process.stderr);
  p.on('error', reject).on('close', exitCode => exitCode === 0 ? resolve() : reject(exitCode));
});

const removeDangling = imagesThatMatchedTags => {
  return Promise.all(imagesThatMatchedTags.map(image => docker.getImage(image.Id).then(info => {
    if (!info.RepoTags.length) {
      // no longer tagged (is dangling)
      process.stdout.write(`Removing dangling image ${ info.Id }, previously tagged "${ image.RepoTags.join(' ') }"\n`);
      return docker.rmi(info.Id);
    }
    return Promise.resolve();
  })));
};

const buildImageAndRemoveDangling = (() => {
  var _ref = _asyncToGenerator(function* (serviceName, image) {
    const imagesThatMatchTags = yield Promise.all(image.tags.map(function (tag) {
      return docker.getImage(tag).catch(function (err) {
        return undefined;
      });
    }));
    yield buildImage(serviceName, image);
    yield removeDangling(imagesThatMatchTags.filter(function (v) {
      return v !== undefined;
    }));
    return;
  });

  return function buildImageAndRemoveDangling(_x, _x2) {
    return _ref.apply(this, arguments);
  };
})();

const buildImages = toBuild => {
  try {
    toBuild.forEach(([name, images]) => {
      images.forEach(image => {
        if (!(image.file && image.file.length)) {
          throw new Error(`no Dockerfile path given for "${ name }" service image`);
        }
      });
    });
  } catch (err) {
    return Promise.reject(err);
  }
  return toBuild.reduce((promise, [name, images]) => {
    return promise.then(() => {
      return images.reduce((promise, image) => {
        return promise.then(() => buildImageAndRemoveDangling(name, image));
      }, Promise.resolve());
    });
  }, Promise.resolve());
};

const filter = R.pipe(R.toPairs, R.map(R.over(R.lensIndex(1), R.view(R.lensProp('image')))), R.filter(R.pipe(R.view(R.lensIndex(1)), R.both(Array.isArray, R.complement(R.isEmpty)))));

const build = (selectedServices, config) => {
  return buildImages(filter(selectedServices));
};

module.exports = build;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbWRzL2J1aWxkLmpzIl0sIm5hbWVzIjpbIlIiLCJyZXF1aXJlIiwic3Bhd24iLCJleGVjIiwiZm9ybWF0Iiwic3BsaXQiLCJwcmVmaXhMaW5lcyIsInRocm91Z2giLCJkb2NrZXIiLCJjb2xvciIsImMiLCJwdXNoIiwiY2h1bmsiLCJlbmMiLCJjYiIsIl9idWlsZEltYWdlIiwiZmlsZSIsImNvbnRleHQiLCJ0YWdzIiwiYXJncyIsInRhZ0FyZ3MiLCJmbGF0dGVuIiwibWFwIiwidGFnIiwiYnVpbGRBcmdzIiwicGlwZSIsInRvUGFpcnMiLCJrZXkiLCJ2YWx1ZSIsImRvY2tlckFyZ3MiLCJwcm9jZXNzIiwic3Rkb3V0Iiwid3JpdGUiLCJqb2luIiwiYnVpbGRJbWFnZSIsInNlcnZpY2VOYW1lIiwiaW1hZ2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInAiLCJzdGRlcnIiLCJvbiIsImV4aXRDb2RlIiwicmVtb3ZlRGFuZ2xpbmciLCJpbWFnZXNUaGF0TWF0Y2hlZFRhZ3MiLCJhbGwiLCJnZXRJbWFnZSIsIklkIiwidGhlbiIsImluZm8iLCJSZXBvVGFncyIsImxlbmd0aCIsInJtaSIsImJ1aWxkSW1hZ2VBbmRSZW1vdmVEYW5nbGluZyIsImltYWdlc1RoYXRNYXRjaFRhZ3MiLCJjYXRjaCIsInVuZGVmaW5lZCIsImZpbHRlciIsInYiLCJidWlsZEltYWdlcyIsInRvQnVpbGQiLCJmb3JFYWNoIiwibmFtZSIsImltYWdlcyIsIkVycm9yIiwiZXJyIiwicmVkdWNlIiwicHJvbWlzZSIsIm92ZXIiLCJsZW5zSW5kZXgiLCJ2aWV3IiwibGVuc1Byb3AiLCJib3RoIiwiQXJyYXkiLCJpc0FycmF5IiwiY29tcGxlbWVudCIsImlzRW1wdHkiLCJidWlsZCIsInNlbGVjdGVkU2VydmljZXMiLCJjb25maWciLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLElBQUlDLFFBQVEsT0FBUixDQUFWOztlQUNzQkEsUUFBUSxlQUFSLEM7O01BQWZDLEssWUFBQUEsSztNQUFPQyxJLFlBQUFBLEk7O0FBQ2QsTUFBTUMsU0FBU0gsUUFBUSxPQUFSLENBQWY7QUFDQSxNQUFNSSxRQUFRSixRQUFRLE9BQVIsQ0FBZDtBQUNBLE1BQU1LLGNBQWNMLFFBQVEscUJBQVIsQ0FBcEI7QUFDQSxNQUFNTSxVQUFVTixRQUFRLE9BQVIsQ0FBaEI7QUFDQSxNQUFNTyxTQUFTUCxRQUFRLGVBQVIsQ0FBZjs7QUFFQSxNQUFNUSxRQUFTQyxDQUFELElBQU87QUFDbkIsU0FBT0gsUUFBUSxDQUFDSSxJQUFELEVBQU9DLEtBQVAsRUFBY0MsR0FBZCxFQUFtQkMsRUFBbkIsS0FBMEI7QUFDdkNILFNBQUtQLE9BQU9NLENBQVAsRUFBVUUsS0FBVixJQUFtQixJQUF4QjtBQUNBRTtBQUNELEdBSE0sQ0FBUDtBQUlELENBTEQ7O0FBT0EsTUFBTUMsY0FBYyxDQUFDLEVBQUNDLElBQUQsRUFBT0MsVUFBVSxJQUFqQixFQUF1QkMsT0FBTyxFQUE5QixFQUFrQ0MsT0FBTyxFQUF6QyxFQUFELEtBQWtEO0FBQ3BFLFFBQU1DLFVBQVVwQixFQUFFcUIsT0FBRixDQUFVSCxLQUFLSSxHQUFMLENBQVNDLE9BQU8sQ0FBQyxJQUFELEVBQU9BLEdBQVAsQ0FBaEIsQ0FBVixDQUFoQjtBQUNBLFFBQU1DLFlBQVl4QixFQUFFeUIsSUFBRixDQUNoQnpCLEVBQUUwQixPQURjLEVBRWhCMUIsRUFBRXNCLEdBQUYsQ0FBTSxDQUFDLENBQUNLLEdBQUQsRUFBTUMsS0FBTixDQUFELEtBQWtCLENBQUMsYUFBRCxFQUFpQixJQUFFRCxHQUFJLE1BQUdDLEtBQU0sR0FBaEMsQ0FBeEIsQ0FGZ0IsRUFHaEI1QixFQUFFcUIsT0FIYyxFQUloQkYsSUFKZ0IsQ0FBbEI7QUFLQSxRQUFNVSxhQUFhLENBQUMsT0FBRCxFQUFVLEdBQUdULE9BQWIsRUFBc0IsR0FBR0ksU0FBekIsRUFBb0MsSUFBcEMsRUFBMENSLElBQTFDLEVBQWdEQyxPQUFoRCxDQUFuQjtBQUNBYSxVQUFRQyxNQUFSLENBQWVDLEtBQWYsQ0FBc0IsZUFBYUgsV0FBV0ksSUFBWCxDQUFnQixHQUFoQixDQUFxQixLQUF4RDtBQUNBLFNBQU8vQixNQUFNLFFBQU4sRUFBZ0IyQixVQUFoQixDQUFQO0FBQ0QsQ0FWRDs7QUFZQSxNQUFNSyxhQUFhLENBQUNDLFdBQUQsRUFBY0MsS0FBZCxLQUF3QixJQUFJQyxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQzFFLFFBQU1DLElBQUl6QixZQUFZcUIsS0FBWixDQUFWO0FBQ0FJLElBQUVULE1BQUYsQ0FDR04sSUFESCxDQUNRcEIsT0FEUixFQUVHb0IsSUFGSCxDQUVRaEIsTUFBTSxRQUFOLENBRlIsRUFHR2dCLElBSEgsQ0FHUW5CLFlBQWEsSUFBRTZCLFdBQVksTUFBM0IsQ0FIUixFQUlHVixJQUpILENBSVFLLFFBQVFDLE1BSmhCO0FBS0FTLElBQUVDLE1BQUYsQ0FDR2hCLElBREgsQ0FDUXBCLE9BRFIsRUFFR29CLElBRkgsQ0FFUWhCLE1BQU0sS0FBTixDQUZSLEVBR0dnQixJQUhILENBR1FuQixZQUFhLElBQUU2QixXQUFZLE1BQTNCLENBSFIsRUFJR1YsSUFKSCxDQUlRSyxRQUFRVyxNQUpoQjtBQUtBRCxJQUNHRSxFQURILENBQ00sT0FETixFQUNlSCxNQURmLEVBRUdHLEVBRkgsQ0FFTSxPQUZOLEVBRWVDLFlBQVlBLGFBQWEsQ0FBYixHQUFpQkwsU0FBakIsR0FBNkJDLE9BQU9JLFFBQVAsQ0FGeEQ7QUFHRCxDQWYwQyxDQUEzQzs7QUFpQkEsTUFBTUMsaUJBQWtCQyxxQkFBRCxJQUEyQjtBQUNoRCxTQUFPUixRQUFRUyxHQUFSLENBQVlELHNCQUNoQnZCLEdBRGdCLENBQ1pjLFNBQVM1QixPQUFPdUMsUUFBUCxDQUFnQlgsTUFBTVksRUFBdEIsRUFBMEJDLElBQTFCLENBQStCQyxRQUFRO0FBQ25ELFFBQUksQ0FBQ0EsS0FBS0MsUUFBTCxDQUFjQyxNQUFuQixFQUEyQjtBQUFFO0FBQzNCdEIsY0FBUUMsTUFBUixDQUFlQyxLQUFmLENBQ0csNEJBQTBCa0IsS0FBS0YsRUFBRywwQkFBdUJaLE1BQU1lLFFBQU4sQ0FBZWxCLElBQWYsQ0FBb0IsR0FBcEIsQ0FBeUIsTUFEckY7QUFHQSxhQUFPekIsT0FBTzZDLEdBQVAsQ0FBV0gsS0FBS0YsRUFBaEIsQ0FBUDtBQUNEO0FBQ0QsV0FBT1gsUUFBUUMsT0FBUixFQUFQO0FBQ0QsR0FSYSxDQURHLENBQVosQ0FBUDtBQVdELENBWkQ7O0FBY0EsTUFBTWdCO0FBQUEsK0JBQThCLFdBQU9uQixXQUFQLEVBQW9CQyxLQUFwQixFQUE4QjtBQUNoRSxVQUFNbUIsc0JBQXNCLE1BQU1sQixRQUFRUyxHQUFSLENBQVlWLE1BQU1sQixJQUFOLENBQVdJLEdBQVgsQ0FBZSxlQUFPO0FBQ2xFLGFBQU9kLE9BQU91QyxRQUFQLENBQWdCeEIsR0FBaEIsRUFBcUJpQyxLQUFyQixDQUEyQjtBQUFBLGVBQU9DLFNBQVA7QUFBQSxPQUEzQixDQUFQO0FBQ0QsS0FGNkMsQ0FBWixDQUFsQztBQUdBLFVBQU12QixXQUFXQyxXQUFYLEVBQXdCQyxLQUF4QixDQUFOO0FBQ0EsVUFBTVEsZUFBZVcsb0JBQW9CRyxNQUFwQixDQUEyQjtBQUFBLGFBQUtDLE1BQU1GLFNBQVg7QUFBQSxLQUEzQixDQUFmLENBQU47QUFDQTtBQUNELEdBUEs7O0FBQUE7QUFBQTtBQUFBO0FBQUEsSUFBTjs7QUFTQSxNQUFNRyxjQUFjQyxXQUFXO0FBQzdCLE1BQUk7QUFDRkEsWUFBUUMsT0FBUixDQUFnQixDQUFDLENBQUNDLElBQUQsRUFBT0MsTUFBUCxDQUFELEtBQW9CO0FBQ2xDQSxhQUFPRixPQUFQLENBQWUxQixTQUFTO0FBQ3RCLFlBQUksRUFBRUEsTUFBTXBCLElBQU4sSUFBY29CLE1BQU1wQixJQUFOLENBQVdvQyxNQUEzQixDQUFKLEVBQXdDO0FBQ3RDLGdCQUFNLElBQUlhLEtBQUosQ0FBVyxrQ0FBZ0NGLElBQUssa0JBQWhELENBQU47QUFDRDtBQUNGLE9BSkQ7QUFLRCxLQU5EO0FBT0QsR0FSRCxDQVNBLE9BQU9HLEdBQVAsRUFBWTtBQUNWLFdBQU83QixRQUFRRSxNQUFSLENBQWUyQixHQUFmLENBQVA7QUFDRDtBQUNELFNBQU9MLFFBQVFNLE1BQVIsQ0FBZSxDQUFDQyxPQUFELEVBQVUsQ0FBQ0wsSUFBRCxFQUFPQyxNQUFQLENBQVYsS0FBNkI7QUFDakQsV0FBT0ksUUFBUW5CLElBQVIsQ0FBYSxNQUFNO0FBQ3hCLGFBQU9lLE9BQU9HLE1BQVAsQ0FBYyxDQUFDQyxPQUFELEVBQVVoQyxLQUFWLEtBQW9CO0FBQ3ZDLGVBQU9nQyxRQUFRbkIsSUFBUixDQUFhLE1BQU1LLDRCQUE0QlMsSUFBNUIsRUFBa0MzQixLQUFsQyxDQUFuQixDQUFQO0FBQ0QsT0FGTSxFQUVKQyxRQUFRQyxPQUFSLEVBRkksQ0FBUDtBQUdELEtBSk0sQ0FBUDtBQUtELEdBTk0sRUFNSkQsUUFBUUMsT0FBUixFQU5JLENBQVA7QUFPRCxDQXBCRDs7QUFzQkEsTUFBTW9CLFNBQVMxRCxFQUFFeUIsSUFBRixDQUNiekIsRUFBRTBCLE9BRFcsRUFFYjFCLEVBQUVzQixHQUFGLENBQ0V0QixFQUFFcUUsSUFBRixDQUNFckUsRUFBRXNFLFNBQUYsQ0FBWSxDQUFaLENBREYsRUFFRXRFLEVBQUV1RSxJQUFGLENBQU92RSxFQUFFd0UsUUFBRixDQUFXLE9BQVgsQ0FBUCxDQUZGLENBREYsQ0FGYSxFQVFieEUsRUFBRTBELE1BQUYsQ0FDRTFELEVBQUV5QixJQUFGLENBQ0V6QixFQUFFdUUsSUFBRixDQUFPdkUsRUFBRXNFLFNBQUYsQ0FBWSxDQUFaLENBQVAsQ0FERixFQUVFdEUsRUFBRXlFLElBQUYsQ0FBT0MsTUFBTUMsT0FBYixFQUFzQjNFLEVBQUU0RSxVQUFGLENBQWE1RSxFQUFFNkUsT0FBZixDQUF0QixDQUZGLENBREYsQ0FSYSxDQUFmOztBQWdCQSxNQUFNQyxRQUFRLENBQUNDLGdCQUFELEVBQW1CQyxNQUFuQixLQUE4QjtBQUMxQyxTQUFPcEIsWUFBWUYsT0FBT3FCLGdCQUFQLENBQVosQ0FBUDtBQUNELENBRkQ7O0FBSUFFLE9BQU9DLE9BQVAsR0FBaUJKLEtBQWpCIiwiZmlsZSI6ImJ1aWxkLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgUiA9IHJlcXVpcmUoJ3JhbWRhJylcbmNvbnN0IHtzcGF3biwgZXhlY30gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJylcbmNvbnN0IGZvcm1hdCA9IHJlcXVpcmUoJ2NoYWxrJylcbmNvbnN0IHNwbGl0ID0gcmVxdWlyZSgnc3BsaXQnKVxuY29uc3QgcHJlZml4TGluZXMgPSByZXF1aXJlKCdwcmVmaXgtc3RyZWFtLWxpbmVzJylcbmNvbnN0IHRocm91Z2ggPSByZXF1aXJlKCd0aHJvbycpXG5jb25zdCBkb2NrZXIgPSByZXF1aXJlKCcuLi9kb2NrZXItYXBpJylcblxuY29uc3QgY29sb3IgPSAoYykgPT4ge1xuICByZXR1cm4gdGhyb3VnaCgocHVzaCwgY2h1bmssIGVuYywgY2IpID0+IHtcbiAgICBwdXNoKGZvcm1hdFtjXShjaHVuaykgKyAnXFxuJylcbiAgICBjYigpXG4gIH0pXG59XG5cbmNvbnN0IF9idWlsZEltYWdlID0gKHtmaWxlLCBjb250ZXh0ID0gJy4vJywgdGFncyA9IFtdLCBhcmdzID0gW119KSA9PiB7XG4gIGNvbnN0IHRhZ0FyZ3MgPSBSLmZsYXR0ZW4odGFncy5tYXAodGFnID0+IFsnLXQnLCB0YWddKSlcbiAgY29uc3QgYnVpbGRBcmdzID0gUi5waXBlKFxuICAgIFIudG9QYWlycyxcbiAgICBSLm1hcCgoW2tleSwgdmFsdWVdKSA9PiBbJy0tYnVpbGQtYXJnJywgYCR7a2V5fT0ke3ZhbHVlfWBdKSxcbiAgICBSLmZsYXR0ZW5cbiAgKShhcmdzKVxuICBjb25zdCBkb2NrZXJBcmdzID0gWydidWlsZCcsIC4uLnRhZ0FyZ3MsIC4uLmJ1aWxkQXJncywgJy1mJywgZmlsZSwgY29udGV4dF1cbiAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoYCAgPiBkb2NrZXIgJHtkb2NrZXJBcmdzLmpvaW4oJyAnKX1cXG5gKVxuICByZXR1cm4gc3Bhd24oJ2RvY2tlcicsIGRvY2tlckFyZ3MpXG59XG5cbmNvbnN0IGJ1aWxkSW1hZ2UgPSAoc2VydmljZU5hbWUsIGltYWdlKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gIGNvbnN0IHAgPSBfYnVpbGRJbWFnZShpbWFnZSlcbiAgcC5zdGRvdXRcbiAgICAucGlwZShzcGxpdCgpKVxuICAgIC5waXBlKGNvbG9yKCd5ZWxsb3cnKSlcbiAgICAucGlwZShwcmVmaXhMaW5lcyhgJHtzZXJ2aWNlTmFtZX0gfCBgKSlcbiAgICAucGlwZShwcm9jZXNzLnN0ZG91dClcbiAgcC5zdGRlcnJcbiAgICAucGlwZShzcGxpdCgpKVxuICAgIC5waXBlKGNvbG9yKCdyZWQnKSlcbiAgICAucGlwZShwcmVmaXhMaW5lcyhgJHtzZXJ2aWNlTmFtZX0gfCBgKSlcbiAgICAucGlwZShwcm9jZXNzLnN0ZGVycilcbiAgcFxuICAgIC5vbignZXJyb3InLCByZWplY3QpXG4gICAgLm9uKCdjbG9zZScsIGV4aXRDb2RlID0+IGV4aXRDb2RlID09PSAwID8gcmVzb2x2ZSgpIDogcmVqZWN0KGV4aXRDb2RlKSlcbn0pXG5cbmNvbnN0IHJlbW92ZURhbmdsaW5nID0gKGltYWdlc1RoYXRNYXRjaGVkVGFncykgPT4ge1xuICByZXR1cm4gUHJvbWlzZS5hbGwoaW1hZ2VzVGhhdE1hdGNoZWRUYWdzXG4gICAgLm1hcChpbWFnZSA9PiBkb2NrZXIuZ2V0SW1hZ2UoaW1hZ2UuSWQpLnRoZW4oaW5mbyA9PiB7XG4gICAgICBpZiAoIWluZm8uUmVwb1RhZ3MubGVuZ3RoKSB7IC8vIG5vIGxvbmdlciB0YWdnZWQgKGlzIGRhbmdsaW5nKVxuICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShcbiAgICAgICAgICBgUmVtb3ZpbmcgZGFuZ2xpbmcgaW1hZ2UgJHtpbmZvLklkfSwgcHJldmlvdXNseSB0YWdnZWQgXCIke2ltYWdlLlJlcG9UYWdzLmpvaW4oJyAnKX1cIlxcbmBcbiAgICAgICAgKVxuICAgICAgICByZXR1cm4gZG9ja2VyLnJtaShpbmZvLklkKVxuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgfSkpXG4gIClcbn1cblxuY29uc3QgYnVpbGRJbWFnZUFuZFJlbW92ZURhbmdsaW5nID0gYXN5bmMgKHNlcnZpY2VOYW1lLCBpbWFnZSkgPT4ge1xuICBjb25zdCBpbWFnZXNUaGF0TWF0Y2hUYWdzID0gYXdhaXQgUHJvbWlzZS5hbGwoaW1hZ2UudGFncy5tYXAodGFnID0+IHtcbiAgICByZXR1cm4gZG9ja2VyLmdldEltYWdlKHRhZykuY2F0Y2goZXJyID0+IHVuZGVmaW5lZClcbiAgfSkpXG4gIGF3YWl0IGJ1aWxkSW1hZ2Uoc2VydmljZU5hbWUsIGltYWdlKVxuICBhd2FpdCByZW1vdmVEYW5nbGluZyhpbWFnZXNUaGF0TWF0Y2hUYWdzLmZpbHRlcih2ID0+IHYgIT09IHVuZGVmaW5lZCkpXG4gIHJldHVyblxufVxuXG5jb25zdCBidWlsZEltYWdlcyA9IHRvQnVpbGQgPT4ge1xuICB0cnkge1xuICAgIHRvQnVpbGQuZm9yRWFjaCgoW25hbWUsIGltYWdlc10pID0+IHtcbiAgICAgIGltYWdlcy5mb3JFYWNoKGltYWdlID0+IHtcbiAgICAgICAgaWYgKCEoaW1hZ2UuZmlsZSAmJiBpbWFnZS5maWxlLmxlbmd0aCkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5vIERvY2tlcmZpbGUgcGF0aCBnaXZlbiBmb3IgXCIke25hbWV9XCIgc2VydmljZSBpbWFnZWApXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuICBjYXRjaCAoZXJyKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycilcbiAgfVxuICByZXR1cm4gdG9CdWlsZC5yZWR1Y2UoKHByb21pc2UsIFtuYW1lLCBpbWFnZXNdKSA9PiB7XG4gICAgcmV0dXJuIHByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gaW1hZ2VzLnJlZHVjZSgocHJvbWlzZSwgaW1hZ2UpID0+IHtcbiAgICAgICAgcmV0dXJuIHByb21pc2UudGhlbigoKSA9PiBidWlsZEltYWdlQW5kUmVtb3ZlRGFuZ2xpbmcobmFtZSwgaW1hZ2UpKVxuICAgICAgfSwgUHJvbWlzZS5yZXNvbHZlKCkpXG4gICAgfSlcbiAgfSwgUHJvbWlzZS5yZXNvbHZlKCkpXG59XG5cbmNvbnN0IGZpbHRlciA9IFIucGlwZShcbiAgUi50b1BhaXJzLFxuICBSLm1hcChcbiAgICBSLm92ZXIoXG4gICAgICBSLmxlbnNJbmRleCgxKSxcbiAgICAgIFIudmlldyhSLmxlbnNQcm9wKCdpbWFnZScpKVxuICAgIClcbiAgKSxcbiAgUi5maWx0ZXIoXG4gICAgUi5waXBlKFxuICAgICAgUi52aWV3KFIubGVuc0luZGV4KDEpKSxcbiAgICAgIFIuYm90aChBcnJheS5pc0FycmF5LCBSLmNvbXBsZW1lbnQoUi5pc0VtcHR5KSlcbiAgICApXG4gIClcbilcblxuY29uc3QgYnVpbGQgPSAoc2VsZWN0ZWRTZXJ2aWNlcywgY29uZmlnKSA9PiB7XG4gIHJldHVybiBidWlsZEltYWdlcyhmaWx0ZXIoc2VsZWN0ZWRTZXJ2aWNlcykpXG59XG5cbm1vZHVsZS5leHBvcnRzID0gYnVpbGRcbiJdfQ==